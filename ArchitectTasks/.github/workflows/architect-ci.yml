name: ArchitectTasks CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.9'
      
      - name: Build
        run: swift build
      
      - name: Run Tests
        run: swift test
      
      - name: Self Analysis
        run: swift run architect-cli self --json > analysis.json
      
      - name: Upload Analysis Report
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis.json

  # Reusable workflow for analyzing any Swift project
  analyze:
    runs-on: macos-14
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.9'
      
      - name: Build Architect CLI
        run: swift build --product architect-cli
      
      - name: Run Analysis
        id: analysis
        run: |
          swift run architect-cli ci . --json > pr-analysis.json
          echo "findings=$(jq '.summary.totalFindings' pr-analysis.json)" >> $GITHUB_OUTPUT
          echo "tasks=$(jq '.summary.totalTasks' pr-analysis.json)" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('pr-analysis.json', 'utf8'));
            
            let body = '## ðŸ” ArchitectTasks Analysis\n\n';
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| Findings | ${analysis.summary?.totalFindings || 0} |\n`;
            body += `| Tasks | ${analysis.summary?.totalTasks || 0} |\n\n`;
            
            if (analysis.findings && analysis.findings.length > 0) {
              body += '### Top Issues\n\n';
              const byType = {};
              analysis.findings.forEach(f => {
                byType[f.type] = (byType[f.type] || 0) + 1;
              });
              Object.entries(byType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .forEach(([type, count]) => {
                  body += `- **${type}**: ${count}\n`;
                });
            }
            
            if (analysis.tasks && analysis.tasks.length > 0) {
              body += '\n### Suggested Tasks\n\n';
              analysis.tasks.slice(0, 5).forEach((task, i) => {
                body += `${i + 1}. ${task.title}\n`;
              });
              if (analysis.tasks.length > 5) {
                body += `\n_...and ${analysis.tasks.length - 5} more_\n`;
              }
            }
            
            body += '\n---\n_Generated by [ArchitectTasks](https://github.com/yourorg/ArchitectTasks)_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
